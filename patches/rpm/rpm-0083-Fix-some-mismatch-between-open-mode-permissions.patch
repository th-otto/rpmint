From f46e274ceed4a0017da65c1de50a17fee09e4632 Mon Sep 17 00:00:00 2001
From: Thorsten Otto <admin@tho-otto.de>
Date: Sat, 17 Mar 2018 04:32:29 +0100
Subject: [PATCH] Fix some mismatch between open mode/permissions

---
 lib/backend/dbi.h    | 2 +-
 lib/rpmdb.c          | 8 ++++----
 lib/rpmdb_internal.h | 2 +-
 lib/rpmts.c          | 4 ++--
 lib/rpmts.h          | 2 +-
 macros.in            | 2 +-
 python/rpmts-py.c    | 2 +-
 rpmrc.in             | 2 +-
 8 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/lib/backend/dbi.h b/lib/backend/dbi.h
index b39745774..4a684fd8f 100644
--- a/lib/backend/dbi.h
+++ b/lib/backend/dbi.h
@@ -50,7 +50,7 @@ struct rpmdb_s {
     char	* db_fullpath;	/*!< full db path including prefix */
     int		db_flags;
     int		db_mode;	/*!< open mode */
-    int		db_perms;	/*!< open permissions */
+    mode_t	db_perms;	/*!< open permissions */
     char	* db_descr;	/*!< db backend description (for error msgs) */
     struct dbChk_s * db_checked;/*!< headerCheck()'ed package instances */
     rpmdb	db_next;
diff --git a/lib/rpmdb.c b/lib/rpmdb.c
index 25ade7304..61fde7faf 100644
--- a/lib/rpmdb.c
+++ b/lib/rpmdb.c
@@ -434,7 +434,7 @@ exit:
 }
 
 static rpmdb newRpmdb(const char * root, const char * home,
-		      int mode, int perms, int flags)
+		      int mode, mode_t perms, int flags)
 {
     rpmdb db = NULL;
     char * db_home = rpmGetPath((home && *home) ? home : "%{_dbpath}", NULL);
@@ -470,7 +470,7 @@ static rpmdb newRpmdb(const char * root, const char * home,
 
     if (!(perms & 0600)) perms = 0644;	/* XXX sanity */
 
-    db->db_mode = (mode >= 0) ? mode : 0;
+    db->db_mode = (mode >= 0) ? mode : O_RDONLY;
     db->db_perms = (perms >= 0) ? perms : 0644;
     db->db_flags = (flags >= 0) ? flags : 0;
 
@@ -489,7 +489,7 @@ static rpmdb newRpmdb(const char * root, const char * home,
 
 static int openDatabase(const char * prefix,
 		const char * dbpath, rpmdb *dbp,
-		int mode, int perms, int flags)
+		int mode, mode_t perms, int flags)
 {
     rpmdb db;
     int rc;
@@ -545,7 +545,7 @@ int rpmdbOpen (const char * prefix, rpmdb *dbp, int mode, int perms)
     return openDatabase(prefix, NULL, dbp, mode, perms, 0);
 }
 
-int rpmdbInit (const char * prefix, int perms)
+int rpmdbInit (const char * prefix, mode_t perms)
 {
     rpmdb db = NULL;
     int rc;
diff --git a/lib/rpmdb_internal.h b/lib/rpmdb_internal.h
index 92848ab37..4bc5275b6 100644
--- a/lib/rpmdb_internal.h
+++ b/lib/rpmdb_internal.h
@@ -48,7 +48,7 @@ int rpmdbOpen (const char * prefix, rpmdb * dbp, int mode, int perms);
  * @return		0 on success
  */
 RPM_GNUC_INTERNAL
-int rpmdbInit(const char * prefix, int perms);
+int rpmdbInit(const char * prefix, mode_t perms);
 
 /** \ingroup rpmdb
  * Close all database indices and free rpmdb.
diff --git a/lib/rpmts.c b/lib/rpmts.c
index bd6d27256..d6c59c1a0 100644
--- a/lib/rpmts.c
+++ b/lib/rpmts.c
@@ -103,12 +103,12 @@ int rpmtsOpenDB(rpmts ts, int dbmode)
     return rc;
 }
 
-int rpmtsInitDB(rpmts ts, int dbmode)
+int rpmtsInitDB(rpmts ts, mode_t perms)
 {
     rpmtxn txn = rpmtxnBegin(ts, RPMTXN_WRITE);
     int rc = -1;
     if (txn)
-	    rc = rpmdbInit(ts->rootDir, dbmode);
+	    rc = rpmdbInit(ts->rootDir, perms);
     rpmtxnEnd(txn);
     return rc;
 }
diff --git a/lib/rpmts.h b/lib/rpmts.h
index 0448f883a..5e4896a28 100644
--- a/lib/rpmts.h
+++ b/lib/rpmts.h
@@ -241,7 +241,7 @@ int rpmtsOpenDB(rpmts ts, int dbmode);
  * @param dbmode	O_RDONLY or O_RDWR
  * @return		0 on success
  */
-int rpmtsInitDB(rpmts ts, int dbmode);
+int rpmtsInitDB(rpmts ts, mode_t perms);
 
 /** \ingroup rpmts
  * Return the transaction database mode
diff --git a/macros.in b/macros.in
index 54040030b..8709810fc 100644
--- a/macros.in
+++ b/macros.in
@@ -983,7 +983,7 @@ package or when debugging this package.\
 %_datadir		%{_prefix}/share
 %_sysconfdir		/etc
 %_sharedstatedir	%{_prefix}/com
-%_localstatedir		%{_prefix}/var
+%_localstatedir		/var
 %_lib			lib
 %_libdir		%{_exec_prefix}/%{_lib}
 %_includedir		%{_prefix}/include
diff --git a/python/rpmts-py.c b/python/rpmts-py.c
index d56a09c22..23287fee9 100644
--- a/python/rpmts-py.c
+++ b/python/rpmts-py.c
@@ -334,7 +334,7 @@ rpmts_InitDB(rpmtsObject * s)
 {
     int rc;
 
-    rc = rpmtsInitDB(s->ts, O_RDONLY);
+    rc = rpmtsInitDB(s->ts, 0644);
     if (rc == 0)
 	rc = rpmtsCloseDB(s->ts);
 
diff --git a/rpmrc.in b/rpmrc.in
index 775eb3cf0..7008ad498 100644
--- a/rpmrc.in
+++ b/rpmrc.in
@@ -479,7 +479,7 @@ arch_compat: armv7hnl: armv7hl
 arch_compat: armv7hl: armv6hl
 arch_compat: armv6hl: noarch
 
-arch_compat: m68k: noarch
+arch_compat: m68k: m68kmint noarch
 
 arch_compat: atarist: m68kmint noarch
 arch_compat: atariste: m68kmint noarch
-- 
2.16.2

